name: Deploy Slides to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: _gh-pages
        continue-on-error: true

      - name: Setup tools via mise
        uses: jdx/mise-action@v2

      - name: Get dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze

      - name: Determine deploy directory
        id: dir
        run: |
          DIR_NAME=$(echo "${{ inputs.branch }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "name=${DIR_NAME}" >> "$GITHUB_OUTPUT"

      - name: Build web
        run: |
          flutter build web --release \
            --dart-define=SHOW_TIMER=false \
            --base-href "/${{ github.event.repository.name }}/${{ steps.dir.outputs.name }}/"

      - name: Capture OGP image
        env:
          BASE_HREF: /${{ github.event.repository.name }}/${{ steps.dir.outputs.name }}/
        run: |
          npm install playwright http-server
          npx playwright install --with-deps chromium
          mkdir -p "build/serve${BASE_HREF}"
          cp -r build/web/* "build/serve${BASE_HREF}"
          npx http-server build/serve -p 8080 &
          for i in $(seq 1 30); do curl -s "http://localhost:8080${BASE_HREF}" > /dev/null && break; sleep 1; done
          node -e "
            const { chromium } = require('playwright');
            (async () => {
              const browser = await chromium.launch();
              const page = await browser.newPage({ viewport: { width: 1200, height: 630 } });
              await page.goto('http://localhost:8080${BASE_HREF}');
              await page.waitForSelector('flutter-view', { timeout: 60000 });
              await page.waitForTimeout(3000);
              await page.screenshot({ path: 'build/web/ogp.png' });
              await browser.close();
            })();
          "
          kill %1

      - name: Set OGP absolute URL
        run: |
          SITE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.dir.outputs.name }}"
          sed -i "s|content=\"ogp.png\"|content=\"${SITE_URL}/ogp.png\"|" build/web/index.html

      - name: Prepare deployment
        env:
          DIR_NAME: ${{ steps.dir.outputs.name }}
          REPO_NAME: ${{ github.event.repository.name }}
          BRANCH_NAME: ${{ inputs.branch }}
        run: |
          mkdir -p _site

          # Restore existing gh-pages content if available
          if [ -d "_gh-pages" ] && [ "$(ls -A _gh-pages 2>/dev/null)" ]; then
            rsync -a --exclude='.git' _gh-pages/ _site/
          fi

          # Deploy current branch build to its subdirectory
          rm -rf "_site/${DIR_NAME}"
          mkdir -p "_site/${DIR_NAME}"
          cp -r build/web/* "_site/${DIR_NAME}/"

          # Record branch metadata for index generation
          mkdir -p _site/.meta
          echo "${BRANCH_NAME}" > "_site/.meta/${DIR_NAME}"

          # Ensure Jekyll is disabled
          touch _site/.nojekyll

          # Generate root index.html listing all presentations
          ITEMS=""
          for meta_file in _site/.meta/*; do
            [ -f "$meta_file" ] || continue
            dir_name=$(basename "$meta_file")
            branch_name=$(cat "$meta_file")

            # Extract OGP info from deployed index.html
            deployed_html="_site/${dir_name}/index.html"
            og_title=""
            og_desc=""
            has_ogp="false"
            if [ -f "$deployed_html" ]; then
              og_title=$(grep -oP 'og:title[^>]*content="\K[^"]*' "$deployed_html" || true)
              og_desc=$(grep -oP 'og:description[^>]*content="\K[^"]*' "$deployed_html" || true)
            fi
            if [ -f "_site/${dir_name}/ogp.png" ]; then
              has_ogp="true"
            fi

            # Use OGP title or fall back to branch name
            display_title="${og_title:-${branch_name}}"

            if [ "$has_ogp" = "true" ]; then
              ITEMS="${ITEMS}<a href=\"/${REPO_NAME}/${dir_name}/\" class=\"card\"><img src=\"/${REPO_NAME}/${dir_name}/ogp.png\" class=\"card-img\" alt=\"\"><div class=\"card-body\"><div class=\"card-title\">${display_title}</div>"
              if [ -n "$og_desc" ]; then
                ITEMS="${ITEMS}<div class=\"card-desc\">${og_desc}</div>"
              fi
              ITEMS="${ITEMS}</div></a>"
            else
              ITEMS="${ITEMS}<a href=\"/${REPO_NAME}/${dir_name}/\" class=\"card\"><div class=\"card-body\"><div class=\"card-title\">${display_title}</div><div class=\"card-desc\">${branch_name}</div></div></a>"
            fi
          done

          cat > _site/index.html << HTMLEOF
          <!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Presentations</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                background: #1a1a2e;
                color: #e0e0e0;
                min-height: 100vh;
                padding: 3rem 2rem;
              }
              h1 {
                font-size: 2rem;
                font-weight: 700;
                margin-bottom: 2rem;
                color: #ffffff;
              }
              .cards {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
                gap: 1.5rem;
              }
              .card {
                display: block;
                background: #16213e;
                border: 1px solid #2a2a4a;
                border-radius: 12px;
                overflow: hidden;
                text-decoration: none;
                color: inherit;
                transition: border-color 0.2s, transform 0.2s;
              }
              .card:hover {
                border-color: #6366f1;
                transform: translateY(-2px);
              }
              .card-img {
                width: 100%;
                aspect-ratio: 1200 / 630;
                object-fit: cover;
                display: block;
                border-bottom: 1px solid #2a2a4a;
              }
              .card-body {
                padding: 1.2rem 1.5rem;
              }
              .card-title {
                font-size: 1.1rem;
                font-weight: 600;
                color: #c7d2fe;
                margin-bottom: 0.4rem;
              }
              .card-desc {
                font-size: 0.85rem;
                color: #9ca3af;
                line-height: 1.4;
              }
            </style>
          </head>
          <body>
            <h1>Presentations</h1>
            <div class="cards">
              ${ITEMS}
            </div>
          </body>
          </html>
          HTMLEOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
