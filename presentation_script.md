# MCPでFlutterアプリのUI検証フィードバックループを回そう

**第9回 FlutterGakkai**

---

## スライド 1: Title

**MCPでFlutterアプリのUI検証フィードバックループを回そう**

第9回 FlutterGakkai

---

## スライド 2: 自己紹介（3ステップ）

### ステップ 1

📷 **Twitterプロフィール画像**

### ステップ 2

📷 **Zennプロフィール画像**

### ステップ 3

📷 **FlutterGakkai #4 登壇写真**

---

## スライド 3: AI Driven Development（3ステップ）

### ステップ 1

**AI駆動開発が当たり前になった**

Claude Code / Cursor / Codex CLI ...

### ステップ 2

私は

**9割くらいAIエージェントに書かせてる**

（制約がややこしいUI組むときとかだけ手書き）

### ステップ 3

**Claude Code + VS Code**

| Claude Code | VS Code                                 |
| ----------- | --------------------------------------- |
| 基本全部    | 手書きするときだけ AI機能はあえて使わず |

---

## スライド 4: AIの力をもっと引き出したい…

**Claude Codeの開発者が最も重要と言っていること**

→ **フィードバックループ**

📷 **Boris Chernyのツイート画像（boris13.png）**

<https://x.com/bcherny/status/2007179861115511237>

---

## スライド 5: フィードバックループとは

**AIエージェント自体に検証の方法を与えて、動作確認 → 修正のループを回すこと**

### 検証の例

- 🖥️ lint
- 🧪 ユニットテスト
- 📱 AIに実際にUI操作させる ← **今回はこれ**

---

## スライド 6: デモ

📷 **デモ動画プレースホルダー**

（撮影予定）

---

## スライド 7: 本題

**FlutterでもUI検証のフィードバックループを回そう**

---

## スライド 8: UI検証を行う際の構成

### 構成図

```
┌─────────────────┐
│  AIエージェント  │
└────────┬────────┘
         ↓
┌─────────────────────────┐
│  Skills (Option)        │
│  ┌─────┐    ┌─────┐    │
│  │ MCP │    │ CLI │    │
│  └─────┘    └─────┘    │
└────────────┬────────────┘
             ↓
┌─────────────────┐
│  Flutterアプリ  │
└─────────────────┘
```

### UIの把握

- 画面要素の取得
- スクショ

### UI操作

- タップ操作
- テキスト入力

---

## スライド 9: 3つのUI検証MCP

| Maestro MCP            | Mobile MCP       | Marionette MCP      |
| ---------------------- | ---------------- | ------------------- |
| Mobile Dev, Inc.       | Mobile Next      | LeanCode            |
| iOS / Android          | iOS / Android    | 全プラットフォーム  |
| XCUITest / UIAutomator | WDA / ADB        | VM Service Protocol |
| YAMLフロー再利用可     | セットアップ簡単 | Flutter特化・軽量   |

**それぞれ異なるアプローチでUI検証を実現**

---

## スライド 10: dart-mcp: 開発支援MCP（2ステップ）

### ステップ 1: 役割比較

| UI検証 MCP                          | dart-mcp             |
| ----------------------------------- | -------------------- |
| (Maestro / Mobile MCP / Marionette) | (開発支援)           |
| タップ・入力操作                    | ランタイムエラー取得 |
| スクロール                          | ウィジェットツリー   |
| スクリーンショット                  | dart fix / format    |
|                                     | テスト実行           |

### ステップ 2: 実プロジェクト推奨構成

- 24ツール / 6,832 tokens (3.42%)
- UI操作機能はない → UI検証MCPと併用が前提
- DTD連携でFlutter固有情報を取得

---

## スライド 11: 外部アプローチ vs 内部アプローチ

### 外部アプローチ（Maestro / Mobile MCP）

```
┌─────────────┐
│  MCP Server │
└──────┬──────┘
       ↓
┌─────────────┐
│   OS API    │
│(XCUITest/ADB)│
└──────┬──────┘
       ↓
┌─────────────┐
│アプリ（外部操作）│
└─────────────┘
```

- OS標準APIを経由
- アプリ改修不要
- リリースビルドも対応
- iOS/Android対応

### 内部アプローチ（Marionette MCP）

```
┌─────────────┐
│  MCP Server │
└──────┬──────┘
       ↓
┌─────────────────┐
│  Flutterアプリ   │
│ ┌─────────────┐ │
│ │MarionetteBinding│
│ │(Widget Tree直接操作)│
│ └─────────────┘ │
└─────────────────┘
```

- Flutter内部APIを使用
- アプリに統合が必要
- デバッグビルドのみ
- 全プラットフォーム対応

---

## スライド 12: iOS通信の仕組み（2ステップ）

### ステップ 1

**どちらも最終的にXCUITestを使用**

Apple公式のリモートUI操作APIが無いため、迂回が必要

| Maestro                                      | Mobile MCP                                     |
| -------------------------------------------- | ---------------------------------------------- |
| Maestro CLI（Kotlin製）                      | mobilecli（Go製）                              |
| ↓                                            | ↓                                              |
| 独自XCUITestランナー（Swift製・ポート22087） | WDA (WebDriverAgent)（Appium管理・ポート8100） |
| ↓                                            | ↓                                              |
| XCUITest（Apple公式）                        | XCUITest（Apple公式）                          |

### ステップ 2

**中間層が異なる: Maestroは独自開発、Mobile MCPはAppium製WDAを使用**

---

## スライド 13: Androidの2つのアプローチ（2ステップ）

### ステップ 1

| Maestro            | Mobile MCP             |
| ------------------ | ---------------------- |
| **常駐サーバー型** | **コマンド直接実行型** |

**Maestro:**

```
┌──────────────┐
│ Maestro CLI  │（ホストPC）
└──────┬───────┘
       │ gRPC (ポート7001)
       ↓
┌─────────────────────┐
│   Android端末        │
│ ┌─────────────────┐ │
│ │Instrumentation Test│
│ │(gRPCサーバー常駐) │ │
│ └────────┬────────┘ │
│          ↓          │
│ ┌─────────────────┐ │
│ │  UIAutomator    │ │
│ │  (Android公式)  │ │
│ └─────────────────┘ │
└─────────────────────┘
```

**Mobile MCP:**

```
┌──────────────┐
│  mobilecli   │（ホストPC）
└──────┬───────┘
       │ ADB shell
       ↓
┌─────────────────────┐
│   Android端末        │
│ ┌─────────────────┐ │
│ │ input tap 100 200 │
│ │   実行して終了    │ │
│ └─────────────────┘ │
└─────────────────────┘
```

### ステップ 2: 比較

| 項目             | Maestro             | Mobile MCP         |
| ---------------- | ------------------- | ------------------ |
| 通信方式         | gRPC（接続維持）    | ADB（毎回実行）    |
| デバイス側       | APK 2つインストール | インストール不要   |
| 初回セットアップ | サーバー起動待ち    | 不要（即実行）     |
| パフォーマンス   | 高速（接続再利用）  | オーバーヘッドあり |

---

## スライド 14: Marionette: VM Service Protocol（2ステップ）

### ステップ 1

**IDEと同じ仕組みで接続**

Dart VMのデバッグ用プロトコルを使用

```
┌──────────────┐   ┌──────────────┐
│ 通常の使い方  │   │Marionetteの使い方│
│ VS Code      │   │ AIエージェント  │
│ Android Studio│   │              │
└──────┬───────┘   └──────┬───────┘
       ↓                  ↓
┌─────────────────────────────────┐
│     VM Service Protocol         │
│   WebSocket (ws://127.0.0.1:PORT/ws) │
└────────────────┬────────────────┘
                 ↓
┌─────────────────────────────────┐
│          Flutterアプリ           │
│  ┌───────────────────────────┐  │
│  │MarionetteBinding (カスタム拡張)│  │
│  └───────────────────────────┘  │
└─────────────────────────────────┘
```

### 特徴

- **軽量**: 約1,700行の実装（Maestro: ~50,000行）
- **Widget Tree直接操作**: RenderObjectから座標取得、Controllerを直接更新
- **Hot Reload連携**: コード変更→即反映、開発効率UP

### ステップ 2

⚠️ **デバッグビルド専用 - リリースビルドでは使用不可**

---

## スライド 15: アプリ側の対応（3ステップ）

**AI がUIを識別するための工夫**

### 優先度ピラミッド

### ステップ 1: 高優先度

**Key / Semantics**

- 一意のキーで要素を特定
- 最も確実で高速

```dart
ValueKey('submit_button')
```

### ステップ 2: 中優先度

**Text / Type**

- 表示テキストや型名で検索
- 一意でない場合は注意

```dart
text: '送信する'
```

### ステップ 3: 低優先度（最終手段）

**Screenshot**

- 画像認識で座標を特定
- 最終手段・トークン消費大

```dart
coordinates: (x, y)
```

---

## スライド 16: 実装例（2ステップ）

### ステップ 1: Flutter側コード

**Marionette (ValueKey)** - Flutter専用・確実に特定

```dart
ElevatedButton(
  key: const ValueKey('submit_btn'),  // ← ここがポイント
  onPressed: _onSubmit,
  child: const Text('送信'),
)
```

**Maestro (Semantics)** - iOS/Android・resource-idとして認識

```dart
Semantics(
  identifier: 'submit_btn',  // ← ここがポイント
  label: '送信ボタン',
  child: ElevatedButton(
    onPressed: _onSubmit,
    child: const Text('送信'),
  ),
)
```

### ステップ 2: MCP呼び出し

| Marionette               | Maestro                    |
| ------------------------ | -------------------------- |
| `tap(key: 'submit_btn')` | `tap_on(id: 'submit_btn')` |

---

## スライド 17: 比較表

| 項目           | Maestro MCP   | Mobile MCP    | Marionette MCP     |
| -------------- | ------------- | ------------- | ------------------ |
| 対応OS         | iOS / Android | iOS / Android | 全プラットフォーム |
| アプリ改修     | 不要          | 不要          | 必要               |
| リリースビルド | ○             | ○             | ×                  |
| セットアップ   | CLI install   | npx           | dart pub global    |
| ツール数       | 14            | 19            | 9                  |
| トークン占有率 | 1.16%         | 1.57%         | **0.65%**          |

ℹ️ **トークン効率**: MCPツール定義がコンテキストを消費する量。Marionetteは最小限のツール数（9個）で0.65%と最も効率的

---

## スライド 18: まとめ（2ステップ）

### ステップ 1: ユースケース別おすすめ

| iOS/Android モバイルアプリ | Flutter 全プラットフォーム | CI/CD 自動テスト   |
| -------------------------- | -------------------------- | ------------------ |
| **Maestro / Mobile MCP**   | **Marionette MCP**         | **Maestro MCP**    |
| ✓ ネイティブAPI経由で操作  | ✓ 全プラットフォーム対応   | ✓ YAMLフロー再利用 |
| ✓ アプリ改修不要           | ✓ Hot Reload連携           | ✓ 安定した接続     |
| ✓ リリースビルドも対応     | ✓ 軽量・高速               | ✓ 豊富な機能       |

### ステップ 2: 最終メッセージ

**MCPでUI検証フィードバックループを回そう！**

- 階層構造を優先、スクショは最終手段
- ValueKey / Semantics で確実に要素を特定

---

_発表者: K9i a.k.a. たこさん (@K9i_apps)_
_アクセンチュア株式会社 ゆめみ Flutterエンジニア_
